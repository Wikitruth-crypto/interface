import{O as e,M as t,r as s,n,o as i,j as r,S as a,B as l,ar as o,as as c,K as d,aB as u,T as m,ay as p,b6 as x,at as f,A as g,aO as h,u as y,aq as b,aN as v,aP as j,a3 as w,ad as S,az as C,b7 as N,b8 as k,b9 as I,ba as A,bb as B,bc as R,bd as D,be as M,bf as P,bg as T,bh as _,bi as F,bj as E,bk as L,bl as z}from"./vendor-BDtTUao2.js";import{I as K,P as q}from"./imageSwiper-BgYx1-lt.js";import{T as O}from"./text_p-y92iNKCg.js";import{T as W}from"./text_title-CzMJOIVd.js";import{s as U,c as V,S as $}from"./status-D2J4ZcA5.js";import{i as H,b as Y,C as X,P as G,u as J,d as Q,f as Z,c as ee,j as te,k as se,e as ne,g as ie,l as re,m as ae,S as le,a as oe}from"./index-DzM9oNjl.js";import{q as ce,u as de}from"./useBoxOrderAmounts-Df5u3Nzd.js";import{c as ue,d as me,u as pe}from"./hooks-CTGY0WO4.js";import{D as xe,A as fe}from"./index-Jym7e1HN.js";import{u as ge}from"./useReadAllowance-RfFW3xzR.js";import{t as he}from"./time-LdUI4bCQ.js";async function ye(t){try{const{network:s,layer:n}=X,{data:i,error:r}=await U.from("boxes").select("*").eq("network",s).eq("layer",n).eq("id",t).single();if(r)return{box:null,metadataBox:null,error:r};if(!i)return{box:null,metadataBox:null,error:null};const{data:a,error:l}=await U.from("metadata_boxes").select("*").eq("network",s).eq("layer",n).eq("id",t).maybeSingle(),o=a||null,c=function(t){const s=e(t,{deep:!0});return{...s,status:V(s.status,s.deadline,s.buyerId||s.buyer_id),biddersIds:s.biddersIds||[],acceptedToken:s.acceptedToken??void 0,listedMode:s.listedMode??void 0}}(i),d=o?function(e){var t,s;const n=e.encryption_slices_metadata_cid||{},i=e.encryption_passwords||{},r=Array.isArray(e.encryption_file_cid)?e.encryption_file_cid:[],a={slicesMetadataCID_encryption:n.slicesMetadataCID_encryption??n.slicesMetadataCidEncryption??n.slices_metadata_cid_encryption??"",slicesMetadataCID_iv:n.slicesMetadataCID_iv??n.slicesMetadataCidIv??n.slices_metadata_cid_iv??""},l={password_encryption:i.password_encryption??i.passwordEncryption??i.password_encryption??"",password_iv:i.password_iv??i.passwordIv??i.password_iv??""},o=r.map(e=>({fileCID_encryption:e.fileCID_encryption??e.fileCidEncryption??e.file_cid_encryption??"",fileCID_iv:e.fileCID_iv??e.fileCidIv??e.file_cid_iv??""}));return{project:e.project,website:e.website,name:e.name,tokenId:(null==(s=null==(t=e.id)?void 0:t.toString)?void 0:s.call(t))??"",typeOfCrime:e.type_of_crime??"",label:e.label??[],title:e.title??"",nftImage:e.nft_image??"",boxImage:e.box_image??"",country:e.country??"",state:e.state??"",description:e.description??"",eventDate:e.event_date??"",createDate:e.create_date??"",timestamp:Number(e.timestamp??0),mintMethod:e.mint_method,fileList:e.file_list??[],encryptionSlicesMetadataCID:a,encryptionFileCID:o,encryptionPasswords:l,publicKey:e.public_key??""}}(o):null;return{box:c,metadataBox:d,error:null}}catch(s){return{box:null,metadataBox:null,error:be(s)}}}function be(e){return e?"object"==typeof e&&"message"in e?e:new Error("Unknown Supabase error"):null}const ve=(e,n)=>{const{network:i,layer:r}=X,a=!!e&&!!n&&"Storing"!==n.listedMode&&"Selling"!==n.listedMode&&""!==n.buyerId,l=n.listedMode||"",{data:o,isLoading:c,error:d,isFetching:u}=t({queryKey:["box-bidders",i,r,e,l],queryFn:async()=>{const t=await async function(e,t){const{network:s,layer:n}=X;try{let i=null;if("Auctioning"===t){const{data:t,error:r}=await U.from("box_bidders").select("bidder_id").eq("network",s).eq("layer",n).eq("id",e);if(r)return{biddersIds:null,error:r};t&&Array.isArray(t)&&(i=t.map(e=>{const t=e.bidder_id;return"string"==typeof t?t:"bigint"==typeof t?t.toString():(null==t?void 0:t.toString())||""}).filter(e=>""!==e))}return{biddersIds:i&&i.length>0?i:null,error:null}}catch(d){return{biddersIds:null,error:be(d)}}}(e,l);if(t.error)throw t.error;return t},staleTime:3e5,enabled:a});return{biddersIds:s.useMemo(()=>{if(null==o?void 0:o.biddersIds)return o.biddersIds},[null==o?void 0:o.biddersIds]),isLoading:c||u,error:d||null}},je={userState:{roles:[]},modalStatus:{SellAuction:"close",ExtendDeadline:"close",ViewFile:"close",BuyBidPay:"close"}},we=n()(i(e=>({...je,updateUserState:t=>e(e=>({userState:{...e.userState,...t}}),!1,"updateUserState"),updateModalStatus:(t,s)=>e(e=>({modalStatus:{...e.modalStatus,[t]:s}}),!1,"updateModalStatus")}))),Se=s.createContext(void 0),Ce=({boxId:e,children:n})=>{const{box:i,metadataBox:a,isLoading:l}=(e=>{const{network:n,layer:i}=X,{data:r,isLoading:a,error:l,isFetching:o}=t({queryKey:["box-detail",n,i,e],queryFn:async()=>{const t=await ye(e);if(t.error)throw t.error;return t},staleTime:3e5,enabled:!!e});return{box:s.useMemo(()=>{if(null==r?void 0:r.box)return r.box},[null==r?void 0:r.box]),metadataBox:s.useMemo(()=>{if(null==r?void 0:r.metadataBox)return r.metadataBox},[null==r?void 0:r.metadataBox]),boxId:e,isLoading:a||o,error:l||null}})(e),o=(e=>{if(!e)return;const{deadline:t,requestRefundDeadline:s,reviewDeadline:n}=e;let i=!1,r=!0,a=!0;const l=Math.floor(Date.now()/1e3);return t&&(i=Number(t)>l),s&&(r=Number(s)>l),n&&(a=Number(n)>l),{isInRequestRefundDeadline:r,isInReviewRefundDeadline:a,isInDeadline:i,isInExtendDeadlineTimeWindow:l>Number(t)-G.deadlineExtensionWindow}})(i||{}),{address:c}=J()||{},d=Q(e=>{var t,s;if(!c||!Z)return null;const n=e.accounts[Z];if(!n)return null;const i=(null==(t=n[c])?void 0:t.userId)??(null==(s=n[c.toLowerCase()])?void 0:s.userId)??null;return i&&""!==i.trim()?i:null}),{boxRewardsData:u,isLoading:m}=((e,n)=>{const{network:i,layer:r}=X,a=!(!e||!n||""===n.listedMode||"InSecrecy"!==n.status&&"Published"!==n.status),{data:l,isLoading:o,error:c,isFetching:d}=t({queryKey:["box-rewards",i,r,e],queryFn:async()=>{const t=await ce(e);if(t.error)throw t.error;return t},staleTime:3e5,enabled:a});return{boxRewardsData:s.useMemo(()=>{if(null==l?void 0:l.boxRewardsData)return l.boxRewardsData},[null==l?void 0:l.boxRewardsData]),isLoading:o||d,error:c||null}})(e,i||{}),{biddersIds:p,isLoading:x}=ve(e,i||{}),f=we(e=>e.userState.roles),{orderAmountsData:g,isLoading:h}=de(e,d||"",f),y=s.useMemo(()=>({box:i,boxId:e,metadataBox:a,isLoading:l||!i,deadlineCheckState:o,boxRewardsData:u,isLoadingRewards:m,biddersIds:p,isLoadingBidders:x,orderAmountsData:g,isLoadingOrderAmounts:h}),[i,e,a,l,o,u,m,p,x,g,h]);return r.jsx(Se.Provider,{value:y,children:n})},Ne=()=>{const e=s.useContext(Se);if(!e)throw new Error("useBoxContext must be used within BoxProvider");return e},ke=({tokenId:e})=>{const{box:t,metadataBox:s}=Ne();return t?r.jsxs("div",{className:"w-full space-y-6 md:space-y-8",children:[r.jsxs(a,{direction:"vertical",size:"middle",children:[r.jsxs(a,{direction:"horizontal",size:"middle",children:[r.jsx(O,{children:"Truth Box Id:"}),r.jsx(O,{children:e})]}),r.jsxs(a,{direction:"horizontal",size:"middle",children:[r.jsx(O,{children:"Minter:"})," ",r.jsx(O,{children:t.minterId})]}),r.jsxs(a,{direction:"horizontal",size:"middle",children:[r.jsx(O,{children:"Owner:"})," ",r.jsx(O,{children:t.ownerAddress})]}),r.jsxs(a,{direction:"horizontal",size:"middle",children:[r.jsx(O,{children:"Create date:"})," ",r.jsx(O,{children:(null==s?void 0:s.createDate)?new Date(null==s?void 0:s.createDate).toLocaleString():""})]})]}),r.jsx("div",{className:"w-full bg-black rounded-xl md:rounded-2xl overflow-hidden",children:r.jsx("div",{className:"aspect-video md:aspect-[4/3] lg:aspect-video",children:r.jsx(K,{images:[(null==s?void 0:s.boxImage)||"",(null==s?void 0:s.nftImage)||""],className:"w-full"})})}),r.jsx("div",{className:"space-y-4",children:r.jsx(W,{children:null==s?void 0:s.title})}),r.jsxs("div",{className:"flex flex-col gap-2",children:[r.jsx(O,{children:null==s?void 0:s.country}),r.jsx(O,{children:null==s?void 0:s.state}),r.jsx(O,{children:null==s?void 0:s.eventDate})]}),r.jsx("hr",{className:"border-border/50"}),r.jsx("div",{className:"space-y-3",children:r.jsx(O,{children:null==s?void 0:s.description})})]}):r.jsx("div",{className:"w-full flex items-center justify-center py-12",children:r.jsx("div",{className:"text-muted-foreground text-lg font-mono",children:"Loading..."})})},Ie=({children:e,className:t})=>r.jsx("div",{className:ee("flex flex-col md:flex-row w-full ","p-2 items-center gap-2 ","bg-background rounded-md md:rounded-xl",t),children:e}),Ae=({controller:e,className:t,onClick:s,children:n})=>{var i;return r.jsxs(Ie,{className:t,children:[r.jsx(l,{onClick:()=>e.execute({onClick:s}),loading:e.isLoading,disabled:e.isDisabled,children:e.label}),r.jsxs("div",{className:"flex flex-col items-start",children:[(null==(i=e.error)?void 0:i.message)&&r.jsx(O,{type:"error",children:e.error.message}),e.description&&r.jsx("div",{className:"flex flex-col items-start",children:r.jsx(O,{size:"sm",children:e.description})}),n]})]})},Be=n((e,t)=>({functionWriting:null,setFunctionWriting:t=>e({functionWriting:t}),reset:()=>e({functionWriting:null})})),Re=e=>{const{writeContractAsync:t,data:n,error:i,isPending:r,isError:a,isSuccess:l,status:d,reset:u}=o(),{isSuccess:m}=c({hash:n}),{address:p}=J(),[x,f]=s.useState(null),{setFunctionWriting:g}=Be(),h=Q(e=>e.addBoxInteraction);return s.useEffect(()=>{m&&x&&p&&e?Array.isArray(e)?e.forEach(e=>{h(e,x,n)}):h(e,x,n):a&&(u(),g(null))},[m,x,p,e,n,h,a,u]),{writeCustormV2:async e=>{const s=e.functionName;f(s),g(s);try{return await t({address:e.contract.address,abi:e.contract.abi,functionName:e.functionName,args:e.args})}catch(n){throw n}finally{g(null)}},hash:n,error:i,isPending:r,isLoading:"idle"!==d&&"error"!==d&&!m,isSuccess:l,status:d,isError:a,reset:u,isSuccessed:m}},De=["sell","auction","publishByMinter"],Me=["sell","auction","publishByMinter"],Pe=["sell","auction","publishByMinter"],Te=["buy","bid","publishByMinter"],_e=["buy","bid","publishByMinter"],Fe=["requestRefund","completeOrder"],Ee=["cancelRefund","agreeRefund","refuseRefund"],Le=["agreeRefund","cancelRefund","refuseRefund"],ze=["agreeRefund","cancelRefund","refuseRefund"],Ke=["completeOrder","requestRefund","agreeRefund","refuseRefund"],qe=["payConfiFee","publishByBuyer"],Oe=["publishByMinter","publishByBuyer","sell","auction"],We=e=>{const{boxId:t,box:n,deadlineCheckState:i}=Ne(),{userState:r,modalStatus:a}=we(e=>e),{address:l}=J()||{},o=null==l?void 0:l.toLowerCase(),c=[],d=s.useMemo(()=>o&&Z?e=>{var s,n;return(null==(n=null==(s=e.accounts[Z])?void 0:s[o])?void 0:n.boxInteractions[t])??c}:()=>c,[o,t]),u=Q(d);return s.useMemo(()=>{if(!n)return!1;const t=u.map(e=>e.functionWrote)||[],s=r.roles,{isInDeadline:l,isInRequestRefundDeadline:o,isInReviewRefundDeadline:c}=i||{},d=n.isInBlacklist||!1,m=n.status||"Storing",p=Number(n.purchaseTimestamp)||0,x=Number(n.reviewDeadline)||0,f=n.refundPermit||!1,g=!n.buyerId||""===n.buyerId,h=s.includes("Minter"),y=s.includes("Admin"),b=s.includes("Buyer"),v=s.includes("Bidder"),j=s.includes("Other"),w=0===s.length,S=()=>l?h:!w,C=e=>e.every(e=>!t.includes(e));switch(e){case"extendActive":return!d&&h&&l&&(null==i?void 0:i.isInExtendDeadlineTimeWindow)&&C(De)&&"close"===a.ExtendDeadline;case"sellActive":return!d&&"Storing"===m&&S()&&C(Me)&&"close"===a.SellAuction;case"auctionActive":return!d&&"Storing"===m&&S()&&C(Pe)&&"close"===a.SellAuction;case"buyActive":return!d&&0===p&&g&&"Selling"===m&&j&&C(Te);case"bidActive":return!d&&"Auctioning"===m&&(j||v)&&l&&C(_e);case"requestRefundActive":return!d&&!f&&o&&0===x&&"Paid"===m&&b&&C(Fe);case"cancelRefundActive":return!d&&!f&&"Refunding"===m&&b&&C(Ee);case"agreeRefundActive":return!d&&!f&&"Refunding"===m&&(c?y||h:!w)&&C(Le);case"refuseRefundActive":return!d&&!f&&"Refunding"===m&&y&&C(ze);case"completeActive":return!d&&0===x&&!f&&"Paid"===m&&(o?b:!w)&&C(Ke);case"payConfiFeeActive":return!d&&"InSecrecy"===m&&(null==i?void 0:i.isInExtendDeadlineTimeWindow)&&!w&&C(qe);case"publishActive":return!d&&("Storing"===m?h:"InSecrecy"===m&&b)&&C(Oe);case"viewFileActive":return!d&&("Storing"===m||"Selling"===m||"Auctioning"===m?h:"InSecrecy"===m||"Paid"===m?b:("Refunding"===m||"Published"===m)&&!w);default:return!0}},[e,n,o,r.roles,u,a,t])},Ue=e=>{const t=ue(),{box:n,boxId:i}=Ne(),r=we(e=>e.userState.roles),{functionWriting:a}=Be(),{writeCustormV2:l,error:o,isLoading:c,isSuccessed:d}=Re(i),u=!e.activeKey||We(e.activeKey),m=s.useMemo(()=>({box:n,boxId:i,roles:r}),[n,i,r]),p=s.useMemo(()=>s=>e.buildWrite?e.buildWrite(m,t,s):e.contract&&e.functionName&&e.getArgs&&n?{contract:e.contract(t),functionName:e.functionName,args:e.getArgs(m,t)}:null,[e,m,t,n]),x=s.useMemo(()=>p(void 0),[p]),f=e.pendingFunctions??(e.functionName?[e.functionName]:[]),g=f.length>0&&f.includes(a??""),h=null!==a&&!f.includes(a??""),y=!!e.allowedRoles&&!e.allowedRoles.some(e=>r.includes(e)),b=!!e.isDisabled&&e.isDisabled(m),v=!x&&!e.requiresCustomArgs,j=h||g||y||b||!u||v,w=s.useRef(null);s.useEffect(()=>{w.current=a},[a]);return{label:e.label,description:e.description,isLoading:g||c,isDisabled:j,isSuccessed:d,showApprove:!1,error:o,execute:async t=>{var s,n;const i=p(null==t?void 0:t.customArgs);i||!e.requiresCustomArgs?i&&(null==(n=null==t?void 0:t.onClick)||n.call(t),await l({contract:i.contract,functionName:i.functionName,args:i.args})):null==(s=null==t?void 0:t.onClick)||s.call(t)}}},Ve=e=>e.Exchange,$e={buy:{id:"buy",label:"Buy",description:"Buy this box.",activeKey:"buyActive",requiresCustomArgs:!0},bid:{id:"bid",label:"Bid",description:"Bid for this box.",activeKey:"bidActive",requiresCustomArgs:!0},payConfiFee:{id:"payConfiFee",label:"PayConfiFee",activeKey:"payConfiFeeActive",requiresCustomArgs:!0},requestRefund:{id:"requestRefund",label:"Refund",description:"Request refund before the deadline.",contract:Ve,functionName:"requestRefund",getArgs:({boxId:e})=>[e],activeKey:"requestRefundActive"},cancelRefund:{id:"cancelRefund",label:"Cancel",description:"Cancel refund, the transaction will be completed.",contract:Ve,functionName:"cancelRefund",getArgs:({boxId:e})=>[e],activeKey:"cancelRefundActive"},agreeRefund:{id:"agreeRefund",label:"Agree",description:"Agree refund, funds will be returned to the buyer.",contract:Ve,functionName:"agreeRefund",getArgs:({boxId:e})=>[e],activeKey:"agreeRefundActive"},refuseRefund:{id:"refuseRefund",label:"Refuse",description:"Refuse refund, the transaction will be completed.",contract:Ve,functionName:"refuseRefund",getArgs:({boxId:e})=>[e],activeKey:"refuseRefundActive"},completeOrder:{id:"completeOrder",label:"Complete",description:"Complete the order: Paid → InSecrecy.",contract:Ve,functionName:"completeOrder",getArgs:({boxId:e})=>[e],activeKey:"completeActive"},publish:{id:"publish",label:"Publish",description:"Publish the box.",contract:e=>e.TruthBox,functionName:"publishByMinter",getArgs:({boxId:e})=>[e],activeKey:"publishActive",buildWrite:(e,t)=>{const{box:s,boxId:n,roles:i}=e;return s?"Storing"===s.status&&i.includes("Minter")?{contract:t.TruthBox,functionName:"publishByMinter",args:[n]}:"InSecrecy"===s.status&&i.includes("Buyer")?{contract:t.TruthBox,functionName:"publishByBuyer",args:[n]}:null:null}},sell:{id:"sell",label:"Sell",activeKey:"sellActive",requiresCustomArgs:!0,pendingFunctions:["sell"],buildWrite:(e,t,s)=>{if(!s)return null;const{acceptedToken:n,price:i}=s;return{contract:t.Exchange,functionName:"sell",args:[e.boxId,n,i]}}},auction:{id:"auction",label:"Auction",activeKey:"auctionActive",requiresCustomArgs:!0,pendingFunctions:["auction"],buildWrite:(e,t,s)=>{if(!s)return null;const{acceptedToken:n,price:i}=s;return{contract:t.Exchange,functionName:"auction",args:[e.boxId,n,i]}}},extendDeadline:{id:"extendDeadline",label:"Extend Deadline",description:"Extend the deadline of the box.",activeKey:"extendActive",requiresCustomArgs:!0},viewFile:{id:"viewFile",label:"View File",description:"View the confidential file.",activeKey:"viewFileActive",requiresCustomArgs:!0}},He=d.memo(({onClick:e,className:t})=>{const s=Ue($e.completeOrder),{roles:n}=we(e=>e.userState),{helperRewardRate:i}=te();return r.jsx(Ae,{controller:s,className:t,onClick:e,children:!n.includes("Buyer")&&r.jsxs(O,{children:["You will get a ",i,"% reward for completing the transaction."]})})}),Ye=d.memo(({onClick:e,className:t})=>{const s=Ue($e.agreeRefund);return r.jsx(Ae,{controller:s,className:t,onClick:e})}),Xe=d.memo(({onClick:e,className:t})=>{const s=Ue($e.refuseRefund);return r.jsx(Ae,{controller:s,className:t,onClick:e})}),Ge=d.memo(({onClick:e,className:t})=>{const s=Ue($e.cancelRefund);return r.jsx(Ae,{controller:s,className:t,onClick:e})}),{Text:Je,Paragraph:Qe}=m,Ze=({label:e,type:t,cidList:s=[],className:n})=>0===s.length?null:r.jsx("div",{className:n,children:r.jsx(u,{children:r.jsxs(a,{direction:"vertical",size:"small",style:{width:"100%"},children:[r.jsxs(Je,{strong:!0,style:{fontFamily:"monospace",fontSize:13},children:[e,":"]}),s.map((e,s)=>{return r.jsx("div",{style:{display:"flex",alignItems:"center",gap:8,width:"100%"},children:r.jsx(Qe,{copyable:{text:e,icon:[r.jsx(p,{},"copy"),r.jsx(x,{},"check")],tooltips:["Copy","Copied!"]},ellipsis:{tooltip:e},style:{flex:1,fontFamily:"cid"===t||"password"===t?"monospace":void 0,fontSize:13},children:(n=e,"password"===t&&n?"•".repeat(Math.min(n.length,12)):n)})},s);var n})]})})}),et=()=>{const{chainId:e,address:t}=J(),{getPrivateKey_TruthBox:s,setPrivateKey_TruthBox:n}=se(),{session:i,isValidateSession:r,login:a}=ne(),{getPrivateData:l}=function(){const{readContract:e}=H();return{getBasicData:async t=>{try{const s=await e({contractName:Y.TRUTH_BOX,functionName:"getBasicData",args:[t]});return s&&Array.isArray(s)&&s.length>=3?[Number(s[0]),Number(s[1]),Number(s[2])]:[0,0,0]}catch(s){return[0,0,0]}},getStatus:async(t,s=!1)=>{try{const n=await e({contractName:Y.TRUTH_BOX,functionName:"getStatus",args:[t],force:s});return n?Number(n):0}catch(n){return 0}},getDeadline:async(t,s=!1)=>{try{const n=await e({contractName:Y.TRUTH_BOX,functionName:"getDeadline",args:[t],force:s});return n?Number(n):0}catch(n){return 0}},getPrice:async(t,s=!1)=>{try{const n=await e({contractName:Y.TRUTH_BOX,functionName:"getPrice",args:[t],force:s});return n?Number(n):0}catch(n){return 0}},getPrivateData:async(t,s)=>{try{const n=await e({contractName:Y.TRUTH_BOX,functionName:"getPrivateData",args:[t,s]});return n?String(n):""}catch(n){return""}},blacklistSupply:async(t=!1)=>{try{const s=await e({contractName:Y.TRUTH_BOX,functionName:"blacklistSupply",args:[],force:t});return s?Number(s):0}catch(s){return 0}},completeCounts:async(t=!1)=>{try{const s=await e({contractName:Y.TRUTH_BOX,functionName:"completeCounts",args:[],force:t});return s?Number(s):0}catch(s){return 0}},isInBlacklist:async(t,s=!1)=>{try{const n=await e({contractName:Y.TRUTH_BOX,functionName:"isInBlacklist",args:[t],force:s});return!!n&&Boolean(n)}catch(n){return!1}}}}();return{checkPrivateKeyExist:n=>!!s(n,e,t),getPrivateKey:async o=>{const c=s(o,e,t);if(c)return c;let d=null;if(r)d=i.token;else{const e=await a({statement:"I want to view the private data of the box",resources:[o]});e&&(d=e.token)}if(d){const s=await l(o,d);if(s)return n(o,s,e,t),s}return null}}},tt=()=>{const[e,t]=s.useState(null),{decryptList:n,decrypt:i}=(()=>{const[e,t]=s.useState(null),[n,i]=s.useState(null),[r,a]=s.useState(null),[l,o]=s.useState(!1);return{decrypt:async(e,s,n,i)=>{o(!0),a(null);try{const r=await xe.decrypt(e,s,n,i);if(r.success&&r.data)return t(r.data),r.data;{const e=r.error||"Decryption failed";return a(e),null}}catch(r){const e=r instanceof Error?r.message:"Unknown decryption error";return a(e),null}finally{o(!1)}},decryptList:async(e,t,s)=>{o(!0),a(null);try{const n=await xe.decryptList(e,t,s);if(n.success&&n.data)return i(n.data),n.data;{const e=n.error||"Decryption failed";return a(e),null}}catch(n){const e=n instanceof Error?n.message:"Unknown decryption error";return a(e),null}finally{o(!1)}},data:e,dataList:n,error:r,isLoading:l}})();return{decryptionViewFile:async(e,s)=>{try{if(!(s.publicKey&&s.encryptionFileCID&&s.encryptionPasswords&&s.encryptionSlicesMetadataCID))throw new Error("Metadata box is required!");const r=s.encryptionFileCID.map(e=>({iv_bytes:e.fileCID_iv,encrypted_bytes:e.fileCID_encryption})),a=await n(s.publicKey,e,r),l=await i(s.publicKey,e,s.encryptionSlicesMetadataCID.slicesMetadataCID_iv,s.encryptionSlicesMetadataCID.slicesMetadataCID_encryption),o={fileCIDList:a||[],password:await i(s.publicKey,e,s.encryptionPasswords.password_iv,s.encryptionPasswords.password_encryption)||"",slicesMetadataCID:l||""};return t(o),o}catch(r){throw r}},data:e}},st={key:"privateKey",title:"Reading private key"},nt={key:"decrypt",title:"Decrypting file information"},it={key:"done",title:"Done"},rt=({onClose:e})=>{var t;const{box:n,metadataBox:i}=Ne();if(!n||!i)return null;const{steps:a,isProcessing:o,errorMsg:c,result:d,attemptCount:u,maxRetry:m,start:p,retry:x}=(()=>{const{getPrivateKey:e}=et(),{decryptionViewFile:t}=tt(),[n,i]=s.useState([{...st,status:"wait",description:"Reading private key"},{...nt,status:"wait",description:"Decrypting file information"},{...it,status:"wait",description:"Done"}]),[r,a]=s.useState(!1),[l,o]=s.useState(null),[c,d]=s.useState(null),u=s.useRef(0),m=s.useCallback(()=>{i([{...st,status:"wait",description:"Reading private key"},{...nt,status:"wait",description:"Decrypting file information"},{...it,status:"wait",description:"Done"}]),d(null),o(null)},[]),p=s.useCallback((e,t,s)=>{i(n=>n.map(n=>n.key===e?{...n,status:t,description:s??n.description}:n))},[]),x=s.useCallback(async(s,i)=>{var r;if(!s||!i)return d("Box or metadata not found, cannot decrypt."),void p("privateKey","error","Missing necessary data");if(u.current>=5)d("Maximum attempts reached (5 times), please try again later.");else{u.current+=1,a(!0),d(null),p("privateKey","process","Reading private key…");try{const n=s.privateKey?s.privateKey:await e(s.id);if(!n)throw new Error("Cannot read private key, please confirm that the signature authorization has been completed.");p("privateKey","finish","Private key read completed"),p("decrypt","process","Decrypting file information…");const r=await t(n,i);o(r),p("decrypt","finish","Decryption successful"),p("done","finish","Done")}catch(l){const e=(null==l?void 0:l.message)||"Unknown error, please try again later.";d(e),"finish"!==(null==(r=n.find(e=>"privateKey"===e.key))?void 0:r.status)?p("privateKey","error",e):p("decrypt","error",e)}finally{a(!1)}}},[t,e,p,n]),f=s.useCallback((e,t)=>{u.current<5&&x(e,t)},[x]);return{steps:n,isProcessing:r,errorMsg:c,result:l,attemptCount:u.current,maxRetry:5,start:x,retry:f,reset:m}})(),y="create"===(null==i?void 0:i.mintMethod),b=s.useRef(!1);s.useEffect(()=>{b.current||n&&i&&(b.current=!0,p(n,i))},[n,i,p]);const v="finish"===(null==(t=a.find(e=>"decrypt"===e.key))?void 0:t.status),j=Math.max(0,m-u);return r.jsxs(f,{title:"View File",centered:!0,open:!0,closable:!1,maskClosable:!1,onOk:()=>{},onCancel:()=>{e()},okButtonProps:{disabled:!0},cancelButtonProps:{disabled:!1},okText:"Download (Soon)",cancelText:"Close",width:520,children:[!y&&r.jsx(g,{type:"warning",showIcon:!0,message:"This Box is in createAndPublish mode, you can view the file directly in the Published area.",className:"mb-4"}),r.jsx(h,{direction:"vertical",items:a.map(e=>({title:e.title,status:e.status,description:e.description})),className:"mb-4"}),c&&r.jsx(g,{type:"error",showIcon:!0,message:"Operation failed",description:c,className:"mb-3"}),r.jsxs("div",{className:"mb-4 flex items-center justify-between",children:[r.jsxs(O,{children:["Attempts: ",u,"/",m,"（Remaining ",j," times）"]}),r.jsx(l,{type:"link",size:"small",onClick:()=>x(n,i),disabled:o||0===j,className:"px-0",children:"Continue request"})]}),o&&r.jsx(O,{children:"Processing, please wait patiently…"}),v&&r.jsxs("div",{className:"flex flex-col gap-2",children:[r.jsx(Ze,{label:"File CID",type:"cid",cidList:(null==d?void 0:d.fileCIDList)||[]}),r.jsx(Ze,{label:"Password",type:"password",cidList:[(null==d?void 0:d.password)||""]}),r.jsx(Ze,{label:"Slices Metadata CID",type:"cid",cidList:[(null==d?void 0:d.slicesMetadataCID)||""]})]})]})},at=d.memo(({onClick:e,className:t})=>{const[n,i]=s.useState(!1),a=Ue($e.viewFile);return r.jsxs(Ae,{controller:a,className:t,onClick:()=>{null==e||e(),i(!0)},children:[r.jsx(O,{children:"You can view the confidential file here."}),n&&r.jsx(rt,{onClose:()=>i(!1)})]})}),lt=d.memo(({onClick:e,className:t})=>{const s=Ue($e.publish);return r.jsx(Ae,{controller:s,className:t,onClick:e})}),ot=()=>{const{box:e,orderAmountsData:t}=Ne(),{address:n}=J();if(!e||!n)return r.jsx("div",{children:"loading..."});const i=null==t?void 0:t.find(t=>t.token===e.acceptedToken),a=s.useMemo(()=>i?Number(i.amount):0,[i]),l=s.useMemo(()=>e.price?Math.max(0,Number(e.price)-a):0,[e.price,a]),o=ie(e.acceptedToken);return r.jsxs(r.Fragment,{children:[a>0&&r.jsxs("div",{style:{marginBottom:"5px"},children:[r.jsx(O,{children:"In the Auction, you paid:"}),r.jsx(q,{price:a,symbol:null==o?void 0:o.symbol,decimals:null==o?void 0:o.decimals})]}),l>0&&r.jsxs("div",{children:[r.jsx(O,{children:"You need to pay:"}),r.jsx(q,{price:l,symbol:null==o?void 0:o.symbol,decimals:null==o?void 0:o.decimals})]})]})},ct={allowance:{title:"Checking allowance...",descriptions:{idle:"Checking allowance...",pending:"Checking allowance...",success:"Allowance is enough",error:"Checking allowance failed"}},approve:{title:"Approve",descriptions:{idle:"Need to approve",pending:"Approving...",success:"Approve success",error:"Approve failed"}},buy:{title:"Buy",descriptions:{idle:"Ready to buy",pending:"Executing buy operation...",success:"Buy operation success",error:"Buy operation failed"}},bid:{title:"Bid",descriptions:{idle:"Ready to bid",pending:"Executing bid operation...",success:"Bid operation success",error:"Bid operation failed"}},payConfiFee:{title:"PayConfiFee",descriptions:{idle:"Ready to pay confidentiality fee",pending:"Executing pay confidentiality fee operation...",success:"Pay confidentiality fee operation success",error:"Pay confidentiality fee operation failed"}}},dt=(e,t)=>{const s=[{stepKey:"allowance",title:ct.allowance.title,description:ct.allowance.descriptions.success,status:"wait"}];return t||s.push({stepKey:"approve",title:ct.approve.title,description:ct.approve.descriptions.idle,status:"wait"}),"buy"===e?s.push({stepKey:"buy",title:ct.buy.title,description:ct.buy.descriptions.idle,status:"wait"}):"bid"===e?s.push({stepKey:"bid",title:ct.bid.title,description:ct.bid.descriptions.idle,status:"wait"}):"payConfiFee"===e&&s.push({stepKey:"payConfiFee",title:ct.payConfiFee.title,description:ct.payConfiFee.descriptions.idle,status:"wait"}),s};const ut=({open:e,onClose:t,boxId:n,tokenAddress:i,amount:o,functionName:c})=>{const d=me(i),{steps:u,checkAllowance:m,handleApproveClick:p,handleBuyBidClick:x,isLoading:w,isSuccessed:S,status:C,currentStepItem:N,formattedAllowanceAmount:k}=((e,t,n,i)=>{const r=ue(),{address:a}=y(),{readAllowance:l,allowanceAmount:o,isEnough:c}=ge(),{writeCustormV2:d,status:u,isLoading:m,isSuccessed:p}=Re(e),[x,f]=s.useState({steps:dt(i,!1),currentIndex:0}),g=s.useCallback(e=>{const t=dt(i,e),s=t.length>1?1:0;f({steps:t,currentIndex:s})},[i]),h=s.useCallback((e,t)=>{f(s=>{const n=s.steps.findIndex(t=>t.stepKey===e);if(-1===n)return s;const i=(e=>{switch(e){case"pending":return"process";case"success":return"finish";case"error":return"error";default:return"wait"}})(t),r=ct[e].descriptions[t],a=s.steps.map((e,t)=>t===n?{...e,status:i,description:r}:e);let l=s.currentIndex;const o=n===s.currentIndex,c=n<a.length-1;return"finish"===i&&o&&c&&(l=n+1),{steps:a,currentIndex:l}})},[]),{steps:w,currentIndex:S}=x,C=w[S]??w[w.length-1],N=s.useCallback(async e=>{if(!(a&&t&&n&&r.FundManager.address))return;const s=b(n,t.decimals);try{const n=await l(t.address,a,r.FundManager.address,s);"init"!==e&&"approve"!==e||g(n.isEnough),h("allowance","success")}catch(i){h("allowance","error")}},[t,n,l,a,g,h]),k=s.useCallback(async(e=!1)=>{if(!t||!n||!r.FundManager.address)return;const s=e?v:b(n,t.decimals);try{h("approve","pending");const e=re(t.address);await d({contract:e,functionName:"approve",args:[r.FundManager.address,s]}),h("approve","success")}catch(i){h("approve","error")}},[t,n,d,N,h]),I=s.useCallback(async()=>{if(!t||!n||!r)return;let s=r.Exchange;"payConfiFee"===i&&(s=r.TruthBox);try{h(i,"pending"),await d({contract:s,functionName:i,args:[e]}),h(i,"success")}catch(a){h(i,"error")}},[t,n,d,i,e,h]);return{steps:w,currentIndex:S,currentStepItem:C,initializeSteps:g,updateStepStatus:h,checkAllowance:N,handleApproveClick:k,handleBuyBidClick:I,isLoading:m,isEnough:c,isSuccessed:p,status:u,allowanceAmount:o,formattedAllowanceAmount:j(o,(null==t?void 0:t.decimals)??18)}})(n,d,o,c);if(!d||!o)return null;const I=function(e){if(/[eE]/.test(e)){const[t,s]=e.split(/[eE]/),n=parseInt(s,10),[i,r=""]=t.split("."),a=r.length;if(i.length,n>0){const e=i+r,t=n-a;if(t>0)return BigInt(e+"0".repeat(t));if(t<0){const s=e.slice(0,e.length+t);return BigInt(s||"0")}return BigInt(e)}return BigInt(i)}const t=e.split(".")[0];return BigInt(t)}(o),A=j(I,d.decimals),B="approve"===N.stepKey&&"finish"!==N.status,R="buy"===N.stepKey||"bid"===N.stepKey||"payConfiFee"===N.stepKey,D=s.useMemo(()=>u.map(({stepKey:e,...t})=>({key:e,...t})),[u]);s.useEffect(()=>{e&&m("init")},[e,i]);const M=()=>{t()};return r.jsx(f,{title:"Wrap operation process",open:e,onCancel:M,closable:"pending"!==C,maskClosable:"pending"!==C,footer:[r.jsx(l,{onClick:M,disabled:"pending"===C,children:S?"Complete":"Cancel"},"close")],width:450,centered:!0,children:r.jsxs(a,{direction:"vertical",size:"large",style:{width:"100%"},children:[r.jsx(g,{type:"info",message:r.jsxs(a,{direction:"vertical",size:"small",children:[r.jsxs(O,{type:"info",children:["You are about to ",c," this box."]}),r.jsxs(O,{children:["Price: ",A," ",null==d?void 0:d.symbol]})]}),showIcon:!0}),r.jsx(h,{direction:"vertical",items:D,size:"small"}),B&&r.jsxs(a,{direction:"vertical",size:"middle",style:{width:"100%"},children:[r.jsx(g,{type:"warning",message:r.jsx(a,{direction:"vertical",size:"small",children:r.jsxs(O,{children:["Allowance is not enough. Current: ",k,", Required: ",o]})}),showIcon:!0}),r.jsxs(l,{type:"primary",onClick:()=>p(!1),loading:w,disabled:!B,block:!0,children:["Approve ",A," ",null==d?void 0:d.symbol]}),r.jsx(l,{type:"primary",onClick:()=>p(!0),loading:w,disabled:!B,block:!0,children:"Approve Max(uint256)"})]}),"approve"===N.stepKey&&"process"===N.status&&r.jsx(g,{type:"info",message:"Approving token...",showIcon:!0}),R&&r.jsx(l,{type:"primary",onClick:x,loading:w,disabled:!R,block:!0,children:c}),u.some(e=>"error"===e.status)&&r.jsx(g,{type:"error",message:"Operation failed",description:"Please check network connection and wallet status, then try again.",showIcon:!0}),S&&r.jsx(g,{type:"success",message:"Wrap operation completed successfully",showIcon:!0})]})})},mt=d.memo(({onClick:e,className:t})=>{var n;const i=Ue($e.bid),{box:a}=Ne(),[l,o]=s.useState(!1),c=null==a?void 0:a.acceptedToken,d=s.useMemo(()=>{const e=null==a?void 0:a.price;return e?e.toString():"0"},[null==a?void 0:a.price]);return r.jsxs(Ae,{controller:i,className:t,onClick:()=>{null==e||e(),o(!0)},children:[r.jsx("div",{className:"w-full mt-2 flex-col",children:r.jsx(ot,{})}),c&&r.jsx(ut,{open:l,onClose:()=>o(!1),boxId:(null==(n=null==a?void 0:a.id)?void 0:n.toString())||"",tokenAddress:c,amount:d,functionName:"bid"})]})}),pt=d.memo(({onClick:e,className:t})=>{var n;const i=Ue($e.buy),{box:a}=Ne(),[l,o]=s.useState(!1),c=null==a?void 0:a.acceptedToken,d=s.useMemo(()=>{const e=null==a?void 0:a.price;return e?e.toString():"0"},[null==a?void 0:a.price]);return r.jsx(Ae,{controller:i,className:t,onClick:()=>{null==e||e(),o(!0)},children:c&&r.jsx(ut,{open:l,onClose:()=>o(!1),boxId:(null==(n=null==a?void 0:a.id)?void 0:n.toString())||"",tokenAddress:c,amount:d,functionName:"buy"})})}),xt=({options:e,value:t,defaultValue:n,onChange:i,placeholder:a="Please select",className:l,disabled:o=!1,searchable:c=!0,searchPlaceholder:u="Search...",filterFunction:m,onSearch:p,noResultsText:x="No matching results",allowClear:f=!0,maxDisplayOptions:g=10})=>{const[h,y]=s.useState(""),[b,v]=s.useState(""),j=void 0!==t;j||e.find(e=>String(e.value)===b),s.useEffect(()=>{n&&!j&&v(String(n.value))},[n,j]),s.useEffect(()=>{j&&t?v(String(t.value)):j&&!t&&v("")},[t,j]);const S=(e,t)=>{const s=t.toLowerCase().trim();return!s||(e.name.toLowerCase().includes(s)||e.symbol&&e.symbol.toLowerCase().includes(s)||String(e.value).toLowerCase().includes(s))},C=d.useMemo(()=>{if(!c||!h)return e.slice(0,g);const t=m||S;return e.filter(e=>t(e,h)).slice(0,g)},[e,h,c,m,g]),N=e=>r.jsxs("div",{className:"flex items-center gap-3 w-full",children:[e.icon&&r.jsx("img",{src:e.icon,alt:"icon",className:"w-5 h-5 rounded-full flex-shrink-0 object-cover"}),r.jsx("span",{className:"truncate font-mono flex-1",children:e.name}),e.symbol&&r.jsx("span",{className:"text-muted-foreground font-mono text-sm flex-shrink-0",children:e.symbol})]}),k=C.map(e=>({label:N(e),value:String(e.value)}));return r.jsx("div",{className:ee("w-full",l),children:r.jsx(w,{value:b||void 0,onChange:t=>(t=>{const s=e.find(e=>String(e.value)===t);j||v(t),null==i||i(s||null)})(t||""),disabled:o||0===k.length,placeholder:a,allowClear:f,onClear:()=>{j||v(""),null==i||i(null),y("")},showSearch:c,onSearch:e=>{y(e),p&&p(e)},filterOption:!1,options:k,notFoundContent:h?x:"No options",className:"w-full",optionLabelProp:"label"})})},ft=({onChange:e})=>{const t=pe(),[n,i]=s.useState(null),a=t.filter(e=>e.canAcceptToken).map(e=>({index:e.index,name:e.name,symbol:e.symbol,value:e.address,decimals:e.decimals}));return s.useEffect(()=>{i(a[0])},[]),r.jsx(xt,{options:a,value:n,onChange:t=>{e(t),i(t)},placeholder:"Please select a token"})},gt=({onClose:e,listedMode:t,controller:n})=>{const i=we(e=>e.updateModalStatus),{roles:a}=we(e=>e.userState),{boxId:l,box:o}=Ne(),c=ae[0].address,d=ae[0].decimals,[u,m]=s.useState(""),[p,x]=s.useState(c),[g,h]=s.useState(d);s.useEffect(()=>{i("SellAuction","open")},[]);const y=()=>{i("SellAuction","close"),e()};if(!o)return r.jsx("div",{children:"loading..."});const v=a.includes("Minter");return r.jsx(f,{title:"Sell"===t?"Sell Truth Box":"Auction Truth Box",centered:!0,open:!0,closable:!1,maskClosable:!1,onOk:async()=>{if(n.isSuccessed)return void y();if(!o)return;let e=p,t=BigInt(0);if(a.includes("Minter")){if(!p)return void C.error("Token is required");t=u&&Number(u)>0?b(String(u),g):BigInt(0)}await n.execute({customArgs:{acceptedToken:e,price:t}})},onCancel:y,okButtonProps:{disabled:n.isLoading},cancelButtonProps:{disabled:n.isLoading},okText:n.isLoading?"Processing...":n.isSuccessed?"Success":"Submit",cancelText:"Close",width:450,children:r.jsxs("div",{className:"flex flex-col gap-2",children:[r.jsxs("div",{className:"flex flex-col gap-2 text-foreground",children:[r.jsxs(O,{children:["boxId:",l]}),r.jsxs("div",{className:"flex flex-row gap-2 items-baseline",children:[r.jsx(O,{children:"Current Price:"}),r.jsx(q,{price:o.price,symbol:ae[0].symbol,decimals:ae[0].decimals})]}),r.jsx("hr",{className:"my-2"}),v?r.jsxs("div",{className:"flex flex-col gap-2",children:[r.jsxs("div",{className:"flex flex-col gap-2 items-start",children:[r.jsx(O,{children:"Accpet Token:"}),r.jsx(ft,{onChange:e=>{x(null==e?void 0:e.value),h(null==e?void 0:e.decimals)}})]}),r.jsxs("div",{className:"flex flex-col gap-2 items-baseline",children:[r.jsx(O,{children:"Price:"}),r.jsx(S,{onChange:e=>(e=>{m(null==e?"":String(e))})(e),value:u?Number(u):void 0,placeholder:"Enter price"})]}),r.jsx(O,{children:"If you don't enter the price, the default price will be used."})]}):r.jsx(O,{children:"Only Minter can set price!"})]}),r.jsx("hr",{className:"my-2"})]})})},ht=d.memo(({onClick:e,className:t})=>{const[n,i]=s.useState(!1),a=Ue($e.sell),{roles:l}=we(e=>e.userState),{helperRewardRate:o}=te();return r.jsxs(Ae,{controller:a,className:t,onClick:()=>{null==e||e(),a.isDisabled||i(!0)},children:[r.jsx("div",{className:"flex flex-col items-start",children:l.includes("Minter")?r.jsx(O,{children:"You can sell or auction the Box at any time."}):r.jsxs(O,{children:["Sell or auction the Box, you can get the Rewards, the Rewards is ",o,"% of the Box price."]})}),n&&r.jsx(gt,{onClose:()=>{i(!1)},listedMode:"Sell",controller:a})]})}),yt=d.memo(({onClick:e,className:t})=>{const[n,i]=s.useState(!1),a=Ue($e.auction),{initialAuctionPeriod:l}=te();return r.jsxs(Ae,{controller:a,className:t,onClick:()=>{null==e||e(),i(!0)},children:[r.jsxs(O,{children:["Start the auction, the initial auction period is ",l/24/3600," days."]}),n&&r.jsx(gt,{onClose:()=>{i(!1)},listedMode:"Auction",controller:a})]})}),bt=d.memo(({onClick:e,className:t})=>{const s=Ue($e.requestRefund),{box:n}=Ne();return r.jsx(Ae,{controller:s,className:t,onClick:e,children:r.jsx("div",{className:ee("flex flex-col items-start"),children:r.jsxs(O,{type:"info",children:["Request Refund Deadline: ",he(Number(null==n?void 0:n.requestRefundDeadline))]})})})}),vt=d.memo(({onClick:e,className:t})=>{var n;const i=Ue($e.payConfiFee),{box:a}=Ne(),{confidentialityFeeExtensionPeriod:l,incrementRate:o}=te(),[c,d]=s.useState(!1),u=null==a?void 0:a.acceptedToken,m=s.useMemo(()=>{const e=null==a?void 0:a.price;return e?e.toString():"0"},[null==a?void 0:a.price]);return r.jsxs(Ae,{controller:i,className:t,onClick:()=>{null==e||e(),d(!0)},children:[r.jsxs("div",{className:ee("flex flex-col items-start"),children:[r.jsxs(O,{children:["Pay the confidentiality fee to extend the confidentiality period: ",l/24/3600," days"]}),r.jsxs(O,{children:["The increment rate: ",o,"%"]})]}),u&&r.jsx(ut,{open:c,onClose:()=>d(!1),boxId:(null==(n=null==a?void 0:a.id)?void 0:n.toString())||"",tokenAddress:u,amount:m,functionName:"payConfiFee"})]})}),jt=({onClose:e})=>{const{boxId:t,box:n}=Ne(),i=we(e=>e.updateModalStatus),{writeCustormV2:a,error:l,isLoading:o,isSuccessed:c}=Re(t),d=ue(),[u,m]=s.useState(!1),[p,x]=s.useState("Submit"),[g,h]=s.useState("");if(!n)return r.jsx("div",{children:"loading..."});s.useEffect(()=>{i("ExtendDeadline","open")},[]),s.useEffect(()=>{c?(m(!1),x("Success")):o?(m(!0),x("wait...")):l&&(m(!1),x("Submit"))},[l,o,c]);return r.jsxs(f,{title:"Extend Deadline",centered:!0,open:!0,closable:!1,maskClosable:!1,onOk:async()=>{if(g&&Number(g)>0){const e=24*Number(g)*60*60;await a({contract:d.TruthBox,functionName:"extendDeadline",args:[t,e]})}else alert("Empty data!")},onCancel:()=>{i("ExtendDeadline","close"),e()},okButtonProps:{disabled:u},cancelButtonProps:{disabled:u},okText:p,cancelText:"Close",width:450,children:[r.jsxs("div",{className:"flex flex-col gap-2",children:[r.jsxs("div",{className:"flex flex-row gap-2 items-baseline",children:[r.jsx(O,{children:"Current boxId:"}),r.jsx(O,{children:t})]}),r.jsx("div",{className:"flex flex-col gap-2",children:r.jsxs("div",{className:"flex flex-col gap-2 w-full",children:[r.jsx(O,{children:"Days:"}),r.jsx("div",{className:"flex flex-row w-full",children:r.jsx(S,{value:g,suffix:"days",precision:0,min:"1",step:10,placeholder:"Input timestamp",onChange:e=>(e=>{h(e)})(e||"")})})]})})]}),r.jsx("hr",{className:"my-2"})]})},wt=d.memo(({onClick:e,className:t})=>{const[n,i]=s.useState(!1),a=Ue($e.extendDeadline);return r.jsx(Ae,{controller:a,className:t,onClick:()=>{null==e||e(),a.isDisabled||i(!0)},children:n&&r.jsx(jt,{onClose:()=>{i(!1)}})})}),St=({})=>{const{box:e}=Ne();return e?r.jsxs("div",{className:"flex flex-col items-start justify-center gap-4",children:[r.jsx(ht,{}),r.jsx(yt,{}),r.jsx(wt,{}),r.jsx(lt,{}),r.jsx(at,{})]}):r.jsx("div",{children:"loading..."})},Ct=({})=>{we(e=>e);const{box:e}=Ne();return e?r.jsxs("div",{className:"flex flex-col items-start justify-center gap-4",children:[!e.buyerId&&Number(e.deadline)<Math.floor(Date.now()/1e3)&&r.jsx("div",{className:"mb-4",children:r.jsx(g,{type:"warning",message:"Warning",description:"No one bought, the transaction is over, please public this Truth Box"})}),r.jsx(pt,{}),r.jsx(lt,{}),r.jsx(at,{})]}):r.jsx("div",{children:"loading..."})},Nt=({})=>{const e=we(e=>e),{roles:t}=e.userState,{box:s,biddersIds:n}=Ne();return s?r.jsxs("div",{className:"flex flex-col items-start justify-center gap-4",children:[t.includes("Minter")||t.includes("Admin")||t.includes("Seller")||t.includes("Buyer")?r.jsx(g,{type:"warning",message:"Warning",description:"You are not authorized to participate in the bidding."}):r.jsx(r.Fragment,{}),0===(null==n?void 0:n.length)&&Number(s.deadline)<Math.floor(Date.now()/1e3)&&r.jsx("div",{className:"mb-4",children:r.jsx(g,{type:"warning",message:"Warning",description:"No one participated in the auction, the auction is over, please public this Truth Box"})}),r.jsx(mt,{}),r.jsx(lt,{}),r.jsx(at,{})]}):r.jsx("div",{children:"loading..."})},kt=({})=>{const{box:e}=Ne();return e?r.jsxs("div",{className:"flex flex-col items-start justify-center gap-4",children:[r.jsx(N,{}),r.jsx(bt,{}),r.jsx(He,{}),r.jsx(at,{})]}):r.jsx("div",{children:"loading..."})},It=({})=>{const{box:e}=Ne();return e?r.jsxs("div",{className:"flex flex-col items-start justify-center gap-4",children:[r.jsx(Ye,{}),r.jsx(Xe,{}),r.jsx(Ge,{}),r.jsx(at,{})]}):r.jsx("div",{children:"loading..."})},At=({})=>{const e=we(e=>e),{roles:t}=e.userState,{box:s}=Ne();return s?r.jsxs("div",{className:"flex flex-col items-start justify-center gap-4",children:[t.includes("Buyer")&&r.jsx("div",{className:"mb-4",children:r.jsx(g,{type:"info",message:"Info",description:"Each time the confidentiality period is extended, an additional confidentiality fee must be paid."})}),r.jsx(vt,{}),r.jsx(lt,{}),r.jsx(at,{})]}):r.jsx("div",{children:"loading..."})},Bt=({})=>{const{box:e,metadataBox:t}=Ne(),{decryptionViewFile:n}=tt();s.useRef(n).current=n;const[i,a]=s.useState([]),[l,o]=s.useState(null),c=(null==t?void 0:t.mintMethod)||"create",d="create"===c;if(s.useEffect(()=>t?"createAndPublish"===t.mintMethod?(a(t.fileList||[]),void o(null)):void 0:(a([]),void o("Metadata not found, cannot show download information.")),[t]),!e)return r.jsx("div",{children:"loading..."});const u=i.length>0;return r.jsxs("div",{className:"flex w-full flex-col items-start justify-center gap-4",children:[r.jsxs(O,{children:["You can use the link to download the file. If the password is empty,",r.jsx("br",{}),"it means that a password is not required."]}),t&&r.jsxs(O,{children:["The current Box uses the ",r.jsx("strong",{className:"text-primary",children:c})," mode to publish,",d?" need to decrypt to get file CID / password.":" metadata directly contains file CID."]}),l&&r.jsx(g,{type:"error",showIcon:!0,message:"Cannot show file information",description:l}),i.length>0?r.jsx(Ze,{label:"File CID",type:"cid",cidList:i}):r.jsx(at,{}),!l&&t&&!u&&r.jsx(O,{children:"Metadata does not contain files to display."})]})},Rt={statusNode:({data:e})=>r.jsxs("div",{className:"relative",children:[r.jsx(M,{type:"target",position:P.Left,style:{background:"#555"}}),r.jsx($,{status:e.status,size:e.size,responsive:e.responsive,disabled:!e.isActive}),r.jsx(M,{type:"source",position:P.Right,style:{background:"#555"}})]})},Dt=({status:e="Storing",listedMode:t="Selling",className:n,size:i="md",responsive:a=!0,showControls:l=!1,showBackground:o=!0,draggable:c=!1,fixedSize:d=!1})=>{const u=s.useCallback(s=>{if(!e)return!1;return({Storing:["Storing"],Selling:["Storing","Selling"],Auctioning:["Storing","Auctioning"],Paid:["Storing",t,"Paid"],Refunding:["Storing",t,"Paid","Refunding"],InSecrecy:["Storing",t,"Paid","InSecrecy"],Published:["Storing",t,"Paid","InSecrecy","Published"],Blacklisted:["Storing","Blacklisted"]}[e]||[]).includes(s)},[e,t]),m=s.useCallback(()=>{const e={sm:{storing:{x:0,y:40},selling:{x:120,y:20},auctioning:{x:120,y:60},paid:{x:240,y:40},inSecrecy:{x:360,y:20},refunding:{x:360,y:60},published:{x:480,y:40}},md:{storing:{x:0,y:60},selling:{x:150,y:30},auctioning:{x:150,y:90},paid:{x:300,y:60},inSecrecy:{x:450,y:30},refunding:{x:450,y:90},published:{x:600,y:60}},lg:{storing:{x:0,y:80},selling:{x:200,y:40},auctioning:{x:200,y:120},paid:{x:400,y:80},inSecrecy:{x:600,y:40},refunding:{x:600,y:120},published:{x:800,y:80}}};return e[i]||e.md},[i]),p=s.useCallback(()=>{const t=m();return[{id:"storing",position:t.storing,data:{status:"Storing",isActive:u("Storing"),isCurrent:"Storing"===e,size:i,responsive:a},type:"statusNode"},{id:"selling",position:t.selling,data:{status:"Selling",isActive:u("Selling"),isCurrent:"Selling"===e,size:i,responsive:a},type:"statusNode"},{id:"auctioning",position:t.auctioning,data:{status:"Auctioning",isActive:u("Auctioning"),isCurrent:"Auctioning"===e,size:i,responsive:a},type:"statusNode"},{id:"paid",position:t.paid,data:{status:"Paid",isActive:u("Paid"),isCurrent:"Paid"===e,size:i,responsive:a},type:"statusNode"},{id:"inSecrecy",position:t.inSecrecy,data:{status:"InSecrecy",isActive:u("InSecrecy"),isCurrent:"InSecrecy"===e,size:i,responsive:a},type:"statusNode"},{id:"refunding",position:t.refunding,data:{status:"Refunding",isActive:u("Refunding"),isCurrent:"Refunding"===e,size:i,responsive:a},type:"statusNode"},{id:"published",position:t.published,data:{status:"Published",isActive:u("Published"),isCurrent:"Published"===e,size:i,responsive:a},type:"statusNode"}]},[m,u,e,i,a]),x=s.useMemo(()=>[{id:"storing-selling",source:"storing",target:"selling"},{id:"storing-auctioning",source:"storing",target:"auctioning"},{id:"selling-paid",source:"selling",target:"paid"},{id:"auctioning-paid",source:"auctioning",target:"paid"},{id:"paid-inSecrecy",source:"paid",target:"inSecrecy"},{id:"paid-refunding",source:"paid",target:"refunding"},{id:"inSecrecy-published",source:"inSecrecy",target:"published"},{id:"refunding-published",source:"refunding",target:"published"}],[]),[f,g,h]=k(p()),[y,b,v]=I(x);s.useEffect(()=>{g(p())},[p,g]);const j=s.useCallback(e=>b(t=>A(e,t)),[]),w=s.useCallback(()=>{const e={sm:"80px",md:"120px",lg:"160px"};return e[i]||e.md},[i]),S=s.useCallback(()=>{const e={sm:"720px",md:"920px",lg:"1120px"};return e[i]||e.md},[i]);return r.jsx("div",{className:ee("bg-background ",n),style:{height:d?w():"100%",width:d?S():"100%",position:"relative",overflow:"hidden"},children:r.jsxs(B,{nodes:f,edges:y,onNodesChange:h,onEdgesChange:v,onConnect:j,nodeTypes:Rt,fitView:!0,fitViewOptions:{padding:.3},nodesDraggable:c,nodesConnectable:!1,elementsSelectable:!1,panOnDrag:!1,zoomOnScroll:!1,zoomOnPinch:!1,zoomOnDoubleClick:!1,preventScrolling:!1,proOptions:{hideAttribution:!0},children:[o&&r.jsx(R,{}),l&&r.jsx(D,{})]},`flow-${y.length}-${f.length}`)})},Mt=({status:e,listedMode:t,className:n,size:i="md",responsive:a=!0,showBackground:l=!0,showIndicator:o=!0,enableHorizontalScroll:c=!1})=>(s.useEffect(()=>{c&&(e=>{const t=document.querySelector(`#status-step-flow-${e}`);t&&t.scrollIntoView({behavior:"smooth",inline:"center"})})(e)},[c,e]),r.jsxs("div",{className:ee("bg-background relative",n),style:{width:"100%",position:"relative"},children:[c&&o&&r.jsxs(r.Fragment,{children:[r.jsx("div",{className:"absolute left-0 top-0 w-8 h-full bg-gradient-to-r from-background via-background/80 to-transparent z-10 flex items-center justify-start pl-1 pointer-events-none",children:r.jsx(T,{className:"w-4 h-4 text-muted-foreground/60 animate-pulse"})}),r.jsx("div",{className:"absolute right-0 top-0 w-8 h-full bg-gradient-to-l from-background via-background/80 to-transparent z-10 flex items-center justify-end pr-1 pointer-events-none",children:r.jsx(_,{className:"w-4 h-4 text-muted-foreground/60 animate-pulse"})})]}),r.jsx("div",{className:ee(c&&"status-step-flow-container"),style:c?{overflowX:"auto",overflowY:"hidden",width:"100%"}:{width:"100%",overflow:"hidden"},children:r.jsx("div",{style:c?{display:"flex",justifyContent:"center",alignItems:"center",minWidth:"fit-content",width:"max-content"}:{width:"100%",height:"100%"},children:r.jsx(Dt,{status:e,listedMode:"Auctioning"!==t?"Selling":t,size:i,responsive:a,showBackground:l,fixedSize:c})})})]})),Pt=({value:e,unit:t,size:n,responsive:i=!0})=>{const a=s.useMemo(()=>{const e={sm:{number:i?"text-xl sm:text-2xl lg:text-3xl":"text-2xl",unit:i?"text-sm sm:text-base":"text-base",padding:i?"px-2 py-1 sm:px-3 sm:py-2":"px-3 py-2",spacing:i?"ml-1 mr-1 sm:ml-1 sm:mr-2":"ml-1 mr-2"},md:{number:i?"text-2xl sm:text-3xl lg:text-4xl":"text-3xl",unit:i?"text-base sm:text-lg":"text-lg",padding:i?"px-3 py-2 sm:px-4 sm:py-3 lg:px-5 lg:py-4":"px-4 py-3",spacing:i?"ml-1 mr-2 sm:ml-2 sm:mr-3 lg:mr-3":"ml-2 mr-3"},lg:{number:i?"text-3xl sm:text-4xl lg:text-5xl":"text-4xl",unit:i?"text-lg sm:text-xl":"text-xl",padding:i?"px-4 py-3 sm:px-5 sm:py-4 lg:px-6 lg:py-5":"px-5 py-4",spacing:i?"ml-2 mr-3 sm:ml-2 sm:mr-4 lg:mr-4":"ml-2 mr-4"}};return e[n]||e.md},[n,i]);return r.jsxs("div",{className:"flex items-baseline",children:[r.jsx("span",{className:ee("font-medium text-foreground bg-secondary rounded-lg transition-all duration-200",a.number,a.padding),children:e.toString().padStart(2,"0")}),r.jsx("span",{className:ee("text-muted-foreground font-normal",a.unit,a.spacing),children:t})]})},Tt=({targetTime:e,size:t="md",className:n,showStatus:i=!0,customStatusText:a,onCountdownEnd:l,direction:o="vertical",responsive:c=!0})=>{const d=s.useCallback(()=>{const t=Math.floor(Date.now()/1e3),s=e-t;let n={days:0,hours:0,minutes:0,seconds:0};return s>0?(n={days:Math.floor(s/86400),hours:Math.floor(s/3600%24),minutes:Math.floor(s/60%60),seconds:Math.floor(s%60)},{timeLeft:n,status:"counting"}):{timeLeft:n,status:"ended"}},[e]),[u,m]=s.useState(()=>{const{timeLeft:e}=d();return e}),[p,x]=s.useState(()=>{const{status:e}=d();return e}),f=s.useMemo(()=>({counting:(null==a?void 0:a.counting)||"Countdown",ended:(null==a?void 0:a.ended)||"Countdown has ended"}),[a]),g=s.useMemo(()=>{const e={sm:{spacing:c?"space-y-2 sm:space-y-3":"space-y-3",statusText:c?"text-lg sm:text-xl":"text-xl",containerPadding:c?"p-3 sm:p-4":"p-4"},md:{spacing:c?"space-y-3 sm:space-y-4 lg:space-y-5":"space-y-4",statusText:c?"text-xl sm:text-2xl lg:text-3xl":"text-2xl",containerPadding:c?"p-4 sm:p-6 lg:p-8":"p-6"},lg:{spacing:c?"space-y-4 sm:space-y-6 lg:space-y-8":"space-y-6",statusText:c?"text-2xl sm:text-3xl lg:text-4xl":"text-3xl",containerPadding:c?"p-6 sm:p-8 lg:p-10":"p-8"}};return e[t]||e.md},[t,c]);s.useEffect(()=>{const e=setInterval(()=>{const{timeLeft:e,status:t}=d();m(e),p!==t&&(x(t),"ended"===t&&l&&l())},1e3);return()=>clearInterval(e)},[e,d,p,l]);const h=s.useMemo(()=>[{value:u.days,unit:"D",label:"Days"},{value:u.hours,unit:"H",label:"Hours"},{value:u.minutes,unit:"M",label:"Minutes"},{value:u.seconds,unit:"S",label:"Seconds"}],[u]),y=s.useMemo(()=>{const e="flex justify-center items-center";return"horizontal"===o?`${e} flex-row space-x-4 sm:space-x-6`:`${e} flex-col ${g.spacing}`},[o,g.spacing]),b=s.useMemo(()=>"flex flex-row justify-center items-center space-x-1 sm:space-x-2",[o]);return r.jsxs("div",{className:ee("w-full bg-background rounded-lg border border-border/50 md:rounded-2xl",y,g.containerPadding,n),children:[i&&r.jsx("p",{className:ee("text-center font-medium","counting"===p?"text-foreground":"text-muted-foreground",g.statusText),children:f[p]}),r.jsx("div",{className:b,children:h.map((e,s)=>r.jsx(Pt,{value:e.value,unit:e.unit,size:t,responsive:c},e.unit))})]})},_t=()=>{const{roles:e}=we(e=>e.userState),{login:t,isLoading:n}=ne();return(()=>{const{box:e,biddersIds:t}=Ne(),{address:n,isConnected:i,chainId:r}=J()||{},{isValidateSession:a}=ne(),{updateUserState:l}=we(),o=Q(e=>{var t,s;const i=r||Z;if(!i||!n)return"";const a=e.accounts[i];return a?(null==(t=a[n])?void 0:t.userId)??(null==(s=a[n.toLowerCase()])?void 0:s.userId)??"":""});s.useEffect(()=>{let s=[];if(l({roles:s}),!n||!i||!e)return;if(!a)return;const r=String(o).trim(),c=e.sellerId?String(e.sellerId).trim():"",d=e.buyerId?String(e.buyerId).trim():"",u=e.minterId?String(e.minterId).trim():"",m=e.completerId?String(e.completerId).trim():"";t&&t.length>0&&r&&""!==r&&t.some(e=>e===r)&&d!==r&&s.push("Bidder"),l({roles:((null==n?void 0:n.toLowerCase())===fe.toLowerCase()&&s.push("Admin"),r&&""!==r&&(r===u&&s.push("Minter"),r===c&&s.push("Seller"),r===d&&s.push("Buyer"),r===m&&s.push("Completer")),0===s.length&&s.push("Other"),s)})},[n,i,e,o,a])})(),r.jsx("div",{className:"flex flex-col items-start justify-center",children:e.length>0?r.jsx(r.Fragment,{children:r.jsx(g,{showIcon:!0,message:`You are: ${e.join(", ")}`,description:"You can do the following actions:",type:"info"})}):r.jsx(r.Fragment,{children:r.jsx(g,{type:"warning",showIcon:!0,message:"You are: Guest, please login!",description:r.jsx(a,{direction:"vertical",size:"small",style:{width:"100%"},children:r.jsx(l,{type:"primary",block:!0,loading:n,onClick:()=>t(),children:"Login"})})})})})},Ft={WTRC:4.8,"WROSE.S":.005,"WTRC.S":4.8},Et=({price:e,token:t,status:n})=>{const{getTokenPrice:i}={getTokenPrice:async(e,t)=>{const s=le.find(t=>t.address===e);if(!s)throw new Error(`Token ${e} not found`);const n=Number(j(BigInt(t),s.decimals));return Ft[s.symbol]*n}},[a,l]=s.useState(0),o=ie(t);s.useEffect(()=>{o&&i(o.address,Number(e)).then(e=>{l(e)})},[o,e]);const c="Published"!==n&&"Blacklisted"!==n;return r.jsx(r.Fragment,{children:c&&r.jsxs("div",{className:"flex items-baseline flex-row gap-2",children:[r.jsx(O,{children:"Price:"}),r.jsx(q,{size:"xl",price:e,symbol:null==o?void 0:o.symbol,decimals:null==o?void 0:o.decimals}),a>0&&r.jsxs("span",{className:"flex items-baseline flex-row gap-2",children:[r.jsx(O,{children:"≈"}),r.jsx(q,{size:"lg",price:a,symbol:"USD"})]})]})})},Lt=[{name:"Twitter",icon:r.jsx(F,{className:"w-5 h-5 md:w-6 md:h-6"}),getUrl:(e,t)=>`https://twitter.com/intent/tweet?url=${encodeURIComponent(t)}&text=${encodeURIComponent(e)}`,color:"hover:bg-primary/10 text-primary"},{name:"Facebook",icon:r.jsx(E,{className:"w-5 h-5 md:w-6 md:h-6"}),getUrl:(e,t)=>`https://www.facebook.com/sharer/sharer.php?u=${encodeURIComponent(t)}`,color:"hover:bg-primary/10 text-primary"},{name:"Telegram",icon:r.jsx(L,{className:"w-5 h-5 md:w-6 md:h-6"}),getUrl:(e,t)=>`https://t.me/share/url?url=${encodeURIComponent(t)}&text=${encodeURIComponent(e)}`,color:"hover:bg-primary/10 text-primary"}],zt=({title:e="",description:t="",url:s="",className:n=""})=>{const i=e||t||"",a=s||("undefined"!=typeof window?window.location.href:"");return r.jsx("div",{className:`flex w-full flex-row gap-3 md:gap-4 justify-center items-center ${n}`,children:Lt.map(e=>r.jsx("a",{href:e.getUrl(i,a),target:"_blank",rel:"noopener noreferrer","aria-label":`Share to ${e.name}`,className:`rounded-full p-1 md:p-2 shadow-sm transition-colors duration-150 ${e.color} hover:text-primary hover:scale-105`,children:r.jsx("div",{className:"w-4 h-4 md:w-5 md:h-5 flex items-center justify-center text-muted-foreground hover:text-primary ",children:e.icon})},e.name))})},Kt=({tokenId:e})=>{const{box:t,metadataBox:n,isLoading:i}=Ne(),[a,l]=s.useState(""),[o,c]=s.useState("Storing"),[d,u]=s.useState(""),[m,p]=s.useState(0),[x,f]=s.useState("");s.useEffect(()=>{t&&(c(t.status),l(t.price??""),p(Number(t.deadline)),f(t.acceptedToken??""),u(t.listedMode??"Selling"))},[t]);return i?r.jsx("div",{className:"w-full flex items-center justify-center py-12",children:r.jsx("div",{className:"text-muted-foreground text-lg",children:"Loading..."})}):r.jsxs("div",{className:"w-full space-y-4 md:space-y-6",children:[r.jsx($,{status:o}),r.jsx(Mt,{status:o,listedMode:d,size:"sm",enableHorizontalScroll:!0}),"Published"!==o&&r.jsxs(r.Fragment,{children:[r.jsx(Tt,{targetTime:m,size:"sm"}),r.jsx("hr",{className:"border-border/50"})]}),(null==t?void 0:t.isInBlacklist)&&r.jsx(g,{message:"Warning",description:"The NFT is in blacklist, can't do anything!",type:"warning"}),r.jsx(Et,{status:o,price:a,token:x}),r.jsx(_t,{}),(()=>{switch(o){case"Storing":return r.jsx(St,{});case"Selling":return r.jsx(Ct,{});case"Auctioning":return r.jsx(Nt,{});case"Paid":return r.jsx(kt,{});case"Refunding":return r.jsx(It,{});case"InSecrecy":return r.jsx(At,{});case"Published":return r.jsx(Bt,{});default:return null}})(),r.jsx("hr",{className:"border-border/50"}),!1,r.jsx(zt,{title:(null==n?void 0:n.title)??"",description:(null==n?void 0:n.description)??"",image:(null==n?void 0:n.nftImage)??"",url:"undefined"!=typeof window?window.location.href:""})]})},qt=()=>{const{tokenId:e}=z();return r.jsx(r.Fragment,{children:r.jsxs(oe,{className:"py-8 md:py-12 lg:py-16",children:[r.jsx("div",{className:"text-center mb-8 md:mb-12",children:r.jsx("p",{className:"text-xl text-muted-foreground md:text-2xl lg:text-3xl font-bold",children:"Only criminals fear the truth being revealed!"})}),r.jsx("div",{className:"bg-muted/30 backdrop-blur-sm rounded-2xl p-6 md:p-8 lg:p-12",children:r.jsx(Ce,{boxId:e||"",children:r.jsxs("div",{className:"flex w-full flex-col lg:flex-row gap-8 lg:gap-12",children:[r.jsx("div",{className:"flex-1 lg:max-w-2xl",children:r.jsx(ke,{tokenId:e||""})}),r.jsx("div",{className:"hidden lg:block w-px bg-border/50 self-stretch"}),r.jsx("div",{className:"flex-1 lg:max-w-xl",children:r.jsx(Kt,{tokenId:e||""})})]})})})]})})};export{qt as default};
